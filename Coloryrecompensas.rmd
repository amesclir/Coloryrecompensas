---
title: "Color y recompensas"
author: "Marcial"
date: "01/09/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
1. Install and load packages

```{r, echo = F}
#install.packages("picante")
#This will install also package dependences
library(picante)
#This will also load package dependences
#library(ape)
#library(vegan)
#library(permute)
#library(lattice)
#library(nlme)

#install.packages("brranching")
library(brranching)

```


3. Frequency matrix.

```{r, echo = F}
mydata <- read.csv("mydata3.csv", sep = ",", header=TRUE, stringsAsFactors=FALSE, fileEncoding="latin1")
mydata

```



3. Create your tree and plot

```{r, echo = F}

taxa <- as.character(mydata[,2])
mytree <- phylomatic(taxa=taxa,get = 'POST', storedtree = "zanne2014",nodes = FALSE)
plot(mytree, no.margin=TRUE, cex = 0.8)

names(mytree)
mytree$node.label <- ""

write.tree(mytree, file = "mytree.tree")

```



```{r, echo = F}
library(caper)

mytree2 <- read.tree(file="mytree.tree")
write(mytree2$tip.label, "tips.txt")
#fix the names in case you did not
mydata <- read.csv("mydata3.csv", sep = ",", header=TRUE, stringsAsFactors=FALSE, fileEncoding="latin1")
mydata

class(mytree2)
plot(mytree2)
color <- comparative.data(mytree2, mydata, X2.Especies2, vcv=TRUE, vcv.dim=2, na.omit=F, 
	             force.root=FALSE, warn.dropped=T, scope=NULL)
plot(color$phy)
color$phy
color$dropped

    lambda.result1 <- pgls(X3.MSUG ~ X5.NPOL, color, lambda = "ML")
    summary(lambda.result1)
    lambda.result2 <- pgls(X3.MSUG ~ X6.VPOL, color, lambda = "ML")
    summary(lambda.result2)
    lambda.result3 <- pgls(X3.MSUG ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.result3)
    lambda.result4 <- pgls(X3.MSUG ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.result4)
    lambda.result5 <- pgls(X3.MSUG ~ X12.HUE, color, lambda = "ML")
    summary(lambda.result5)
    lambda.result6 <- pgls(X3.MSUG ~ X13.BRI, color, lambda = "ML")
    summary(lambda.result6)
    lambda.result7 <- pgls(X3.MSUG ~ X14.CHR, color, lambda = "ML")
    summary(lambda.result7)
    lambda.result8 <- pgls(X3.MSUG ~ X15.UV, color, lambda = "ML")
    summary(lambda.result8)
    lambda.result9 <- pgls(X3.MSUG ~ X16.GC, color, lambda = "ML")
    summary(lambda.result9)
    lambda.result10 <- pgls(X3.MSUG ~ X17.DIST, color, lambda = "ML")
    summary(lambda.result10)
    
    lambda.resultb1 <- pgls(X4.CSUG ~ X5.NPOL, color, lambda = "ML")
    summary(lambda.resultb1)
    lambda.resultb2 <- pgls(X4.CSUG ~ X6.VPOL, color, lambda = "ML")
    summary(lambda.resultb2)
    lambda.resultb3 <- pgls(X4.CSUG ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.resultb3)
    lambda.resultb4 <- pgls(X4.CSUG ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.resultb4)
    lambda.resultb5 <- pgls(X4.CSUG ~ X12.HUE, color, lambda = "ML")
    summary(lambda.resultb5)
    lambda.resultb6 <- pgls(X4.CSUG ~ X13.BRI, color, lambda = "ML")
    summary(lambda.resultb6)
    lambda.resultb7 <- pgls(X4.CSUG ~ X14.CHR, color, lambda = "ML")
    summary(lambda.resultb7)
    lambda.resultb8 <- pgls(X4.CSUG ~ X15.UV, color, lambda = "ML")
    summary(lambda.resultb8)
    lambda.resultb9 <- pgls(X4.CSUG ~ X16.GC, color, lambda = "ML")
    summary(lambda.resultb9)
    lambda.resultb10 <- pgls(X4.CSUG ~ X17.DIST, color, lambda = "ML")
    summary(lambda.resultb10)

    lambda.resultc1 <- pgls(X5.NPOL ~ X3.MSUG, color, lambda = "ML")
    summary(lambda.resultc1)
    lambda.resultc2 <- pgls(X5.NPOL ~ X4.CSUG, color, lambda = "ML")
    summary(lambda.resultc2)
    lambda.resultc3 <- pgls(X5.NPOL ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.resultc3)
    lambda.resultc4 <- pgls(X5.NPOL ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.resultc4)
    lambda.resultc5 <- pgls(X5.NPOL ~ X12.HUE, color, lambda = "ML")
    summary(lambda.resultc5)
    lambda.resultc6 <- pgls(X5.NPOL ~ X13.BRI, color, lambda = "ML")
    summary(lambda.resultc6)
    lambda.resultc7 <- pgls(X5.NPOL ~ X14.CHR, color, lambda = "ML")
    summary(lambda.resultc7)
    lambda.resultc8 <- pgls(X5.NPOL ~ X15.UV, color, lambda = "ML")
    summary(lambda.resultc8)
    lambda.resultc9 <- pgls(X5.NPOL ~ X16.GC, color, lambda = "ML")
    summary(lambda.resultc9)
    lambda.resultc10 <- pgls(X5.NPOL ~ X17.DIST, color, lambda = "ML")
    summary(lambda.resultc10)
    
    
    lambda.resultd1 <- pgls(X6.VPOL ~ X3.MSUG, color, lambda = "ML")
    summary(lambda.resultd1)
    lambda.resultd2 <- pgls(X6.VPOL ~ X4.CSUG, color, lambda = "ML")
    summary(lambda.resultd2)
    lambda.resultd3 <- pgls(X6.VPOL ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.resultd3)
    lambda.resultd4 <- pgls(X6.VPOL ~ X9.SIZ, color, lambda = "ML")
    summary(lambda.resultd4)
    lambda.resultd5 <- pgls(X6.VPOL ~ X12.HUE, color, lambda = "ML")
    summary(lambda.resultd5)
    lambda.resultd6 <- pgls(X6.VPOL ~ X13.BRI, color, lambda = "ML")
    summary(lambda.resultd6)
    lambda.resultd7 <- pgls(X6.VPOL ~ X14.CHR, color, lambda = "ML")
    summary(lambda.resultd7)
    lambda.resultd8 <- pgls(X6.VPOL ~ X15.UV, color, lambda = "ML")
    summary(lambda.resultd8)
    lambda.resultd9 <- pgls(X6.VPOL ~ X16.GC, color, lambda = "ML")
    summary(lambda.resultd9)
    lambda.resultd10 <- pgls(X6.VPOL ~ X17.DIST, color, lambda = "ML")
    summary(lambda.resultd10)

    
    lambda.resulte1 <- pgls(X9.SIZ ~ X3.MSUG, color, lambda = "ML")
    summary(lambda.resulte1)
    lambda.resulte2 <- pgls(X9.SIZ ~ X4.CSUG, color, lambda = "ML")
    summary(lambda.resulte2)
    lambda.resulte3 <- pgls(X9.SIZ ~ X5.NPOL, color, lambda = "ML")
    summary(lambda.resulte3)
    lambda.resulte4 <- pgls(X9.SIZ ~ X6.VPOL, color, lambda = "ML")
    summary(lambda.resulte4)
    lambda.resulte5 <- pgls(X9.SIZ ~ X12.HUE, color, lambda = "ML")
    summary(lambda.resulte5)
    lambda.resulte6 <- pgls(X9.SIZ ~ X13.BRI, color, lambda = "ML")
    summary(lambda.resulte6)
    lambda.resulte7 <- pgls(X9.SIZ ~ X14.CHR, color, lambda = "ML")
    summary(lambda.resulte7)
    lambda.resulte8 <- pgls(X9.SIZ ~ X15.UV, color, lambda = "ML")
    summary(lambda.resulte8)
    lambda.resulte9 <- pgls(X9.SIZ ~ X16.GC, color, lambda = "ML")
    summary(lambda.resulte9)
    lambda.resulte10 <- pgls(X9.SIZ ~ X17.DIST, color, lambda = "ML")
    summary(lambda.resulte10)

```




4. Calculate phylogenetic diversity statistics.

```{r, echo = F}
mydata[,1] <- tolower(mydata[,1])
mydata[,1] <- chartr(" ", "_", mydata[,1])
setdiff(mydata[,1], mytree$tip.label)
setdiff(mytree$tip.label,mydata[,1])

mytree2$tip.label <- tolower(mytree2$tip.label)
setdiff(mydata[,1], mytree2$tip.label)
setdiff(mytree2$tip.label,mydata[,1])

class(mytree) <- "phylo"
class(mytree2) <- "phylo"

color.plot.phylo(mytree2, mydata, "Caliza_1", "Specie", leg.cex = 0.6, main = "Caliza_1") 
color.plot.phylo(mytree2, mydata, "Caliza_2","Specie", leg.cex = 0.6, main = "Caliza_2") 
color.plot.phylo(mytree2, mydata, "Dolomia_1", "Specie", leg.cex = 0.6, main = "Dolomia_1") 
color.plot.phylo(mytree2, mydata, "Dolomia_2", "Specie", leg.cex = 0.6, main = "Dolomia_2") 
color.plot.phylo(mytree2, mydata, "Brezal_1", "Specie", leg.cex = 0.6, main = "Brezal_1") 
color.plot.phylo(mytree2, mydata, "Brezal_2", "Specie", leg.cex = 0.6, main = "Brezal_2") 
color.plot.phylo(mytree2, mydata, "Brezal_3", "Specie", leg.cex = 0.6, main = "Brezal_3") 
color.plot.phylo(mytree2, mydata, "Brezal_4", "Specie", leg.cex = 0.6, main = "Brezal_4") 
color.plot.phylo(mytree2, mydata, "Alcornocal_1", "Specie", leg.cex = 0.6, main = "Alcornocal_1") 
color.plot.phylo(mytree2, mydata, "Alcornocal_2", "Specie", leg.cex = 0.6, main = "Alcornocal_2") 
color.plot.phylo(mytree2, mydata, "Alcornocal_3", "Specie", leg.cex = 0.6, main = "Alcornocal_3") 
color.plot.phylo(mytree2, mydata, "Quejigal_1", "Specie", leg.cex = 0.6, main = "Quejigal_1") 
color.plot.phylo(mytree2, mydata, "Quejigal_2", "Specie", leg.cex = 0.6, main = "Quejigal_2") 
color.plot.phylo(mytree2, mydata, "Quejigal_3", "Specie", leg.cex = 0.6, main = "Quejigal_3") 


?pd
#Explore the function and run the examples

rownames(mydata) = mydata[,1]

mypd <- pd(t(mydata[,-c(1)]), mytree2, include.root=TRUE)
mypd

?mpd
#Explore the function and run the examples

mympd <- mpd(t(mydata[,-c(1)]), cophenetic(mytree2), abundance.weighted=T)
mympd
myresults1 <- cbind(mypd, mympd)

?mntd
#Explore the function and run the examples

mymntd <- mntd(t(mydata[,-c(1)]), cophenetic(mytree2), abundance.weighted=T)
mymntd
myresults2 <- cbind(myresults1, mymntd)
colnames(myresults2) <- c("PD", "SR", "MPD", "MNTD")
myresults2
write.table(myresults2, file = "diversity_index_results.txt")

mycomdist <- comdist(t(mydata[,-c(1)]), cophenetic(mytree2), abundance.weighted=T)
library(cluster)
mycomdist.clusters <- hclust(mycomdist)
plot(mycomdist.clusters, main = "Dendrogram based on beta MPD")

mycomdistnt1 <- comdistnt(t(mydata[,-c(1,2)]), cophenetic(mytree2), abundance.weighted=F, exclude.conspecifics = T)
mycomdistnt1.clusters <- hclust(mycomdistnt1)
plot(mycomdistnt1.clusters, main = "Dendrogram based on beta MNTD excluding conspecifics")

mycomdistnt2 <- comdistnt(t(mydata[,-c(1,2)]), cophenetic(mytree2), abundance.weighted=F, exclude.conspecifics = F)
mycomdistnt2.clusters <- hclust(mycomdistnt2)
plot(mycomdistnt2.clusters, main = "Dendrogram based on beta MNTD including conspecifics")


```


5. Finally we are going to check for phylogenetic clustering and overdispersion
```{r, echo = F}
my.ses.pd <- ses.pd(t(mydata[,-c(1)]), mytree2, null.model = "taxa.labels",
runs = 999)
my.ses.pd
write.table(my.ses.pd, file="ses.pd.result.txt")

my.ses.mpd <- ses.mpd(t(mydata[,-c(1)]), cophenetic(mytree2), null.model = "taxa.labels",
abundance.weighted = T, runs = 999)
my.ses.mpd
write.table(my.ses.mpd, file="ses.mpd.result.txt")


my.ses.mntd <- ses.mntd(t(mydata[,-c(1)]), cophenetic(mytree2), null.model = "taxa.labels",
abundance.weighted = T, runs = 999)
my.ses.mntd
write.table(my.ses.mntd, file="ses.mntd.result.txt")



comm.phylo.cor.r <- comm.phylo.cor(t(mydata[,-c(1)]), mytree2, metric="cij",null.model="sample.taxa.labels")
comm.phylo.cor.r
par(mai=c(1.02,0.82,0.82,0.42))
hist(comm.phylo.cor.r$random.corrs)
abline(v=comm.phylo.cor.r$obs.corr)

```

